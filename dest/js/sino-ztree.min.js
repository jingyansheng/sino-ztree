/**
 * Sino Ztree
 *
 * Version: v1.0.2
 * Date: 2019-03-29
 */

let sinoZtree={rootId:"137406"};document.onkeydown=(()=>{27==event.keyCode&&sinoZtree.publicEvt.disappear()}),sinoZtree.garage={masker:{tagName:"div",id:"sino-masker",class:"sino-masker"},panel:(e,t)=>({tagName:"div",class:"sino-transfer-panel",children:[{tagName:"div",class:"sino-transfer-panel__header",children:[{tagName:"span",text:t||("left"===e?"数据列表":"已选列表")},{tagName:"span",class:"sino-transfer-panel__header--extra",id:t?"":"left"===e?"":"header-extra",text:t?"":"left"===e?"":"（合计：0）"}]},{tagName:"left"===e?"div":"",class:"sino-transfer-panel__search",children:[{tagName:"input",class:"sino-search",id:"sino-search",type:"text",placeholder:"请输入搜索内容",autocomplete:"off",onkeyup:"sinoZtree.publicEvt.onSearch()"},{tagName:"span",class:"sino-search__icon",children:[{tagName:"span",class:"iconfont icon-sousuo"}]},{tagName:"span",class:"sino-search__close",id:"sino-search-close",children:[{tagName:"span",class:"iconfont icon-quxiao"}],event:{click:()=>{$("#sino-search").val(""),sinoZtree.publicEvt.onSearch()}}}]},{tagName:"div",class:"sino-transfer-panel__body",children:[{tagName:"div",class:"sino-loading",id:"left"===e?"zTree-loading":"sTree-loading",text:"暂无数据"},{tagName:"ul",class:"ztree",id:"left"===e?"zTree":"sTree"},{tagName:"left"===e?"ul":"",class:"ztree",id:"cTree"}]}]}),body:e=>({tagName:"div",class:"sino-ztree__wrapper",id:"sino-ztree",children:[{tagName:"div",class:"sino-ztree",children:[{tagName:"div",class:"sino-ztree__header",children:[{tagName:"div",class:"sino-ztree__title",children:[{tagName:"span",id:"sino-header-title",text:e.title}]},{tagName:"div",class:"sino-ztree__headerbtn",children:[{tagName:"div",class:"sino-ztree__close",children:[{tagName:"span",class:"iconfont icon-guanbi"}],event:{click:()=>{sinoZtree.publicEvt.disappear()}}}]}]},{tagName:"div",class:"sino-ztree__content",children:[{tagName:"div",class:"sino-transfer",id:"sino-transfer",children:[]}]},{tagName:"div",class:"sino-ztree__footer",children:[{tagName:"div",class:"sino-ztree__content",children:[{tagName:"div",class:"sino-left",children:[{tagName:"span",class:"sino-text",text:"提示：双击即可取消已选"}]},{tagName:"div",class:"sino-right",children:[{tagName:"button",class:"sino-button sino-button--primary sino-button--small",text:"确定",event:{click:()=>{sinoZtree.publicEvt.onConfirm()}}},{tagName:"button",class:"sino-button sino-button--small",text:"关闭",event:{click:()=>{sinoZtree.publicEvt.disappear()}}}]}]}]}]}]})},sinoZtree.creator={archives:{excluder:["tagName","children","text","event"]},create:e=>{if(e.tagName){let t=document.createElement(e.tagName);for(let r in e)-1==sinoZtree.creator.archives.excluder.indexOf(r)&&t.setAttribute(r,e[r]);if(e.children)for(let r of e.children){let e=sinoZtree.creator.create(r);e&&t.appendChild(e)}if(e.text&&(t.innerText=e.text),e.event)for(let r in e.event)t.addEventListener(r,e.event[r]);return t}}},sinoZtree.publicEvt={configure:{},appear:(e,t)=>{const r=sinoZtree.creator.create(sinoZtree.garage.masker);$("body").append(r),$("#sino-masker").hide().fadeIn("fast");const n=sinoZtree.creator.create(sinoZtree.garage.body(e));$("body").append(n),$("#sino-transfer").prepend(sinoZtree.creator.create(sinoZtree.garage.panel("left",t))),$("#sino-transfer").append(sinoZtree.creator.create(sinoZtree.garage.panel("right"))),$("#sino-ztree").hide().fadeIn("fast")},disappear:()=>{$("#sino-ztree").fadeOut("fast",function(){$(this).remove()}),$("#sino-masker").fadeOut("fast",function(){$(this).remove()})},init:(e,t)=>{if(!e)return void alert("cfs 参数错误");if(!e.result)return void alert("cfs.result 参数错误");if(!e.config)return void alert("cfs.config 参数错误");if(!e.config.url)return void alert("cfs.config.url 参数错误");let r="";if("dept"===e.config.type)r="公司部门列表",sinoZtree.ztree.zSettings.check.chkboxType={N:"",Y:""},sinoZtree.ztree.cSettings.check.chkboxType={N:"",Y:""};else{if("user"!==e.config.type)return void alert("cfs.config.type 参数错误");r="用户列表",sinoZtree.ztree.zSettings.check.chkboxType={N:"ps",Y:"ps"},sinoZtree.ztree.cSettings.check.chkboxType={N:"ps",Y:"ps"}}e.model&&e.model.title||(e.model.title="dept"===e.config.type?"选择部门":"选择用户");const n=sinoZtree.publicEvt.configure.showParent;e.config.rootId&&e.config.rootId!==sinoZtree.rootId&&n?e.config.rootId=e.config.rootId.substring(0,e.config.rootId.length-3):e.config.rootId=sinoZtree.rootId;const i=parseInt(e.config.max,10)||0;(0===i||i>500)&&(e.config.max=500),sinoZtree.publicEvt.appear(e.model,r),sinoZtree.publicEvt.configure={result:e.result,url:e.config.url,type:e.config.type,rootId:e.config.rootId,max:e.config.max,showLeader:!1!==e.config.showLeader,showCompany:!1!==e.config.showCompany,showParent:!1!==e.config.showParent,hideNodes:e.config.hideNodes||"",callback:t},$.fn.zTree.init($("#zTree"),sinoZtree.ztree.zSettings,null)},onSearch:()=>{if(""!==$("#sino-search").val()){const e=$.fn.zTree.getZTreeObj("zTree").getNodesByParamFuzzy("name",$("#sino-search").val());for(let t=0;t<e.length;t++)if(t>0)for(let r=0;r<t;r++)e[r]&&JSON.stringify(e[r]).indexOf(JSON.stringify(e[t]))>0&&delete e[t];$.fn.zTree.init($("#cTree"),sinoZtree.ztree.cSettings,e),$("#cTree").show(),$("#zTree").hide(),$("#sino-search-close").show()}else $("#cTree").hide(),$("#zTree").show(),$("#sino-search-close").hide()},onConfirm:()=>{const e=$.fn.zTree.getZTreeObj("sTree").getNodes(),t={};if(e){const r={};for(let t=0;t<e.length;t++)for(let n in sinoZtree.publicEvt.configure.result)r[n]||(r[n]=[]),e[t].hasOwnProperty(n)&&r[n].push(e[t][n].toString());for(let e in sinoZtree.publicEvt.configure.result)sinoZtree.publicEvt.configure.callback?t[e]=r[e].toString():$("#"+sinoZtree.publicEvt.configure.result[e]).val(r[e].toString())}else for(let e in sinoZtree.publicEvt.configure.result)sinoZtree.publicEvt.configure.callback?t[e]="":$("#"+sinoZtree.publicEvt.configure.result[e]).val("");sinoZtree.publicEvt.configure.callback&&sinoZtree.publicEvt.configure.callback(t),sinoZtree.publicEvt.disappear()}},sinoZtree.ztree={storage:[],selecteds:[],funcs:{sieve:e=>{e.children?e.children.map((e,t)=>{sinoZtree.ztree.funcs.sieve(e)}):sinoZtree.ztree.storage.push(e)}},zSettings:{check:{enable:!0},data:{simpleData:{enable:!0,idKey:"id",pIdKey:"parentId",rootPId:sinoZtree.publicEvt.configure.rootId}},async:{enable:!0,url:()=>{return sinoZtree.publicEvt.configure.url+"?rootId="+sinoZtree.publicEvt.configure.rootId},autoParam:["id"]},callback:{beforeCheck:(e,t)=>{const r=sinoZtree.publicEvt.configure.max;if(r){if(t.checked)return!0;const e=$.fn.zTree.getZTreeObj("sTree").getNodes();if(sinoZtree.ztree.storage.length=0,"user"===sinoZtree.publicEvt.configure.type?sinoZtree.ztree.funcs.sieve(t):sinoZtree.ztree.storage.push(t),(e?e.length:0)+sinoZtree.ztree.storage.length>r)return alert("当前最大可选数量："+r),!1}},onCheck:(e,t,r)=>{const n=$.fn.zTree.getZTreeObj("sTree");sinoZtree.ztree.storage.length=0,"user"===sinoZtree.publicEvt.configure.type?sinoZtree.ztree.funcs.sieve(r):sinoZtree.ztree.storage.push(r),sinoZtree.ztree.storage.map((e,t)=>{if(e.checked)n.addNodes(null,{id:e.id,parentId:e.parentId,name:e.name,iconSkin:sinoZtree.publicEvt.configure.type});else{const t=n.getNodeByParam("id",e.id);n.removeNode(t)}});const i=n.getNodes()?n.getNodes().length:0;i?($("#sTree").show(),$("#sTree-loading").hide()):($("#sTree").hide(),$("#sTree-loading").show()),$("#header-extra").text(`（合计：${i}）`)},onAsyncSuccess:(e,t,r,n)=>{const i=$.fn.zTree.getZTreeObj("zTree"),o=i.transformToArray(i.getNodes());for(let e=0;e<o.length;e++)o[e].iconSkin||("user"===sinoZtree.publicEvt.configure.type?o[e].isParent?o[e].iconSkin="deptu":o[e].iconSkin="user":"0"===o[e].fromUnit?o[e].iconSkin="depts":"1"===o[e].fromUnit&&(o[e].iconSkin="dept"),o[e].id===sinoZtree.rootId&&(o[e].iconSkin="root"),i.updateNode(o[e]));sinoZtree.ztree.selecteds=[];for(let e in sinoZtree.publicEvt.configure.result){const t=$("#"+sinoZtree.publicEvt.configure.result[e]).val();if(t){const r=t.split(",");for(let t=0;t<r.length;t++)sinoZtree.ztree.selecteds[t]||(sinoZtree.ztree.selecteds[t]={}),sinoZtree.ztree.selecteds[t][e]=r[t],sinoZtree.ztree.selecteds[t].iconSkin=sinoZtree.publicEvt.configure.type}}for(let e=0;e<sinoZtree.ztree.selecteds.length;e++){const t=i.getNodeByParam("id",sinoZtree.ztree.selecteds[e].id);t&&i.checkNode(t,!0,"user"===sinoZtree.publicEvt.configure.type)}if($.fn.zTree.init($("#sTree"),sinoZtree.ztree.sSettings,sinoZtree.ztree.selecteds),sinoZtree.ztree.selecteds.length>0&&($("#sTree").show(),$("#sTree-loading").hide()),!sinoZtree.publicEvt.configure.showLeader){const e=i.getNodesByParamFuzzy("isZhc","3");e&&i.hideNodes(e)}if(!sinoZtree.publicEvt.configure.showCompany){const e=i.getNodesByParam("parentId",sinoZtree.publicEvt.configure.rootId);for(let t=0;t<e.length;t++){const r=i.getNodesByParam("parentId",e[t].id);for(let e=0;e<r.length;e++)"0"===r[e].fromUnit&&i.hideNode(r[e])}}const s=sinoZtree.publicEvt.configure.hideNodes.split(",");for(let e=0;e<s.length;e++){const t=i.getNodesByParamFuzzy("name",s[e]);t&&i.hideNodes(t)}$("#zTree").show(),$("#zTree-loading").hide()},onAsyncError:(e,t,r,n,i,o)=>{$("#zTree-loading").text("获取数据失败"),alert("获取数据失败")}}},sSettings:{view:{showLine:!1},callback:{onDblClick:function(e,t,r){if(r){const e=$.fn.zTree.getZTreeObj("zTree"),t=$.fn.zTree.getZTreeObj("cTree"),i=$.fn.zTree.getZTreeObj("sTree"),o=e.getNodeByParam("id",r.id);if(e.checkNode(o,!1,!0),i.removeNode(r,!1),t){const e=t.getNodesByParam("id",r.id);for(let r=0;r<e.length;r++)t.checkNode(e[r],!1,!0)}var n=i.getNodes();n&&0!==n.length||($("#sTree").hide(),$("#sTree-loading").show()),$("#header-extra").text(`（合计：${n.length}）`)}}}},cSettings:{check:{enable:!0},view:{showLine:!1},callback:{beforeCheck:(e,t)=>{const r=sinoZtree.publicEvt.configure.max;if(r){if(t.checked)return!0;const e=$.fn.zTree.getZTreeObj("sTree").getNodes();if(sinoZtree.ztree.storage.length=0,"user"===sinoZtree.publicEvt.configure.type?sinoZtree.ztree.funcs.sieve(t):sinoZtree.ztree.storage.push(t),(e?e.length:0)+sinoZtree.ztree.storage.length>r)return alert("当前最大可选数量："+r),!1}},onCheck:(e,t,r)=>{const n=$.fn.zTree.getZTreeObj("sTree"),i=$.fn.zTree.getZTreeObj("zTree");sinoZtree.ztree.storage.length=0,"user"===sinoZtree.publicEvt.configure.type?sinoZtree.ztree.funcs.sieve(r):sinoZtree.ztree.storage.push(r),sinoZtree.ztree.storage.map((e,t)=>{if(e.checked){n.addNodes(null,{id:e.id,parentId:e.parentId,name:e.name,iconSkin:sinoZtree.publicEvt.configure.type});const t=i.getNodeByParam("id",e.id);t&&i.checkNode(t,!0,"user"===sinoZtree.publicEvt.configure.type)}else{const t=n.getNodeByParam("id",e.id);n.removeNode(t);const r=i.getNodeByParam("id",e.id);r&&i.checkNode(r,!1,"user"===sinoZtree.publicEvt.configure.type)}});const o=n.getNodes()?n.getNodes().length:0;o?($("#sTree").show(),$("#sTree-loading").hide()):($("#sTree").hide(),$("#sTree-loading").show()),$("#header-extra").text(`（合计：${o}）`)}}}};